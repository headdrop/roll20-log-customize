/*!
   * Rolling Mint
   * roll20-log-customize
   *
   * https://headdrop.github.io/roll20-log-customize/
   *
   * by headdrop
   */
var styleNew=document.styleSheets[4].cssRules,styleLog=document.styleSheets[3].cssRules;const diceinput={0:/("diceroll d10.+?"backing">)/gi,2:/("diceroll d20.+?"backing">)/gi,4:/("diceroll d4.+?"backing">)/gi,6:/("diceroll d6.+?"backing">)/gi,8:/("diceroll d8.+?"backing">)/gi,9:/("diceroll d12.+?"backing">)/gi};function dropdownApp(e,t){$.each(newArr($(e)),(function(e,l){if(""!=l.slice(0,-1)){let e="";e=`<option value='${l.slice(0,-1)}'>${l.slice(0,-1)}</option>`,$(t).append(e)}}))}function newArr(e){for(var t=[],l=0;l<e.length;l++)-1===t.indexOf(e[l].innerText)&&t.push(e[l].innerText);return t.filter((function(e,t,l){return nameArrCheck(e)}))}function nameArrCheck(e){let t=/^\(.+?\)/gi.test(e),l=/^\s+$/gi.test(e);return 1!=t&&1!=l}function cssChange(e,t,l){var n=[];for(i of styleNew)n=n.concat([i.selectorText]);if(-1==n.indexOf(e)){let o=`${e} {${t} : ${l};}`;document.styleSheets[4].insertRule(o,n.length)}for(i of styleNew)i.selectorText==e&&("background-color"==t&&(i.style.backgroundColor=l),"color"==t&&(i.style.color=l))}function update(e){let t=document.querySelector("#highlighting-content");t.innerText=e,hljs.highlightAll(t)}function sync_scroll(e){let t=document.querySelector("#highlighting-content");t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft}function check_tab(e,t){let l=e.value;if("Tab"==t.key){t.preventDefault();let n=l.slice(0,e.selectionStart),o=l.slice(e.selectionEnd,e.value.length),s=e.selectionEnd+2;e.value=n+"  "+o,e.selectionStart=s,e.selectionEnd=s}}function tableColor(e){$("#defaultTable").spectrum({color:e,showAlpha:!0,preferredFormat:"hex",move:function(e){for(i of styleLog)".sheet-rolltemplate-default table"===i.selectorText?i.style.borderColor=e:".sheet-rolltemplate-default caption"===i.selectorText&&(i.style.backgroundColor=e)}}),$("#defaultTable").on("change",(function(){let e=getTextColorByBackgroundColor(rgb2hex(document.getElementById("defaultTable").value));for(i of styleLog)".sheet-rolltemplate-default caption"===i.selectorText&&(i.style.color=e);document.querySelector(".rule-select .sp-preview-inner").style.color=e})),document.querySelector(".rule-select .sp-preview-inner").innerText="표 제목"}function getTextColorByBackgroundColor(e,t){const l=e.substring(1),n=parseInt(l,16),o=n>>16&255,s=n>>8&255,c=n>>0&255;return 1===t?o+","+s+","+c:.2126*o+.7152*s+.0722*c<127.5?"white":"black"}function rgb2hex(e){if(-1==e.search("rgb"))return e;{function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return"#"+t((e=e.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/))[1])+t(e[2])+t(e[3])}}function hideMessageCP(e){let t=e.target.closest(".detail-button");t&&(t.nextElementSibling.classList.toggle("move"),t.firstChild.classList.toggle("move"))}function checkOpt(){if($("#ck-nospacer").is(":checked")?styleNew[1].style.setProperty("background-color","transparent","important"):styleNew[1].style.setProperty("background-color","transparent"),$("#ck-circle").is(":checked")?(styleNew[10].style.borderRadius="100%",styleNew[11].style.alignItems="center"):(styleNew[10].style.borderRadius="0%",styleNew[11].style.alignItems="stretch"),$("#ck-noimg").is(":checked")){for(var e of styleLog)".avatar"===e.selectorText&&(e.style.display="none"),".message"===e.selectorText&&(e.style.paddingLeft="15px"),".message .spacer"===e.selectorText&&(e.style.margin="0 -5px 8px -15px");document.getElementById("ck-circle").disabled=!0}else{for(var e of styleLog)".avatar"===e.selectorText&&(e.style.display=""),".message"===e.selectorText&&(e.style.paddingLeft="45px"),".message .spacer"===e.selectorText&&(e.style.margin="0 -5px 8px -45px");document.getElementById("ck-circle").disabled=!1}if($("#ck-you").is(":checked"))for(var t of styleNew)".message.you"===t.selectorText?t.selectorText=".message.you-noapply":".message.you .spacer"===t.selectorText&&(t.selectorText=".message.you .spacer-noapply");else for(var t of styleNew){let e=t.selectorText;void 0!==e&&-1!==e.indexOf("-noapply")&&(t.selectorText=e.replace("-noapply",""))}$("#ck-time").is(":checked")?styleNew[12].style.display="":styleNew[12].style.display="none",$("#ck-dice").is(":checked")?(styleNew[13].style.display="inline-block",$(".rollresult .cp-area, .rollresult .detail-button").show()):(styleNew[13].style.display="none",$(".rollresult .cp-area, .rollresult .detail-button").hide()),$("#ck-font").is(":checked")?styleNew[14].style.setProperty("font-family",'"Helvetica Neue",Helvetica,Arial,sans-serif',"important"):styleNew[14].style.setProperty("font-family","")}function addID(){let e=document.querySelectorAll("#log-content .by");for(var t of e){var l,n=t.innerText.slice(0,-1);let e=/\S+?(?=\s)/.exec(n);l=/PC\d+?\s/gi.test(n)?n.replace(/PC\d+?\s+?/gi,"").match(/\S+?(?=\s|$)/gi,"")[0]:null==e?n:e.shift(),-1!=t.parentNode.classList.value.indexOf("general")|-1!=t.parentNode.classList.value.indexOf("rollresult")&&(t.parentNode.id=l)}let o=document.querySelectorAll("#log-content .message.general:not([ID]), #log-content .message.rollresult:not([ID])");for(var s of o){for(var c=s.previousElementSibling;""==c.id;)c=c.previousElementSibling;s.id=c.id}}function imgChange(){document.querySelectorAll("#imgList>.changeImg-box").forEach((function(e,t,l){let n=e.childNodes[1].value,o=e.firstChild.firstChild.innerText.replace("의 프로필 이미지","").split(/\s/gi)[0];document.querySelectorAll(`#${o} .avatar>img`).forEach((function(e){e.src=n,e.parentElement.classList.contains("noImage")&&e.parentElement.classList.remove("noImage")}))}))}function makeGlobalCP(e,t,l){let n="color"==t?"color":"background-color",o="general"==e?".message":`.message.${e}`;"spacer"==t&&(o+=" .spacer");let s=$(o).css(n);"bg"==t?$(`.cp-area>[id^=${e}][id$=${t}]`).spectrum({color:s,preferredFormat:"hex3",showAlpha:!0,move:function(e){cssChange(o,n,e)}}):$(`.cp-area>[id^=${e}][id$=${t}]`).spectrum({color:s,preferredFormat:"hex3",move:function(e){cssChange(o,n,e)}})}$((function(){$("#rule").niceSelect(),$("[name='glo-ck']").on("change",checkOpt),$("[name='glo-name']").on("change",(function(){let e=document.querySelector("input[name='glo-name']:checked").value;document.querySelectorAll(".example .general:not(.global)").forEach((n=>{var o=styleNew.length;let s=[];if(byId=n.id,""==byId.index|/\s/g);else{for(i of styleNew)s=s.concat([i.selectorText]);if(-1==s.indexOf("#"+byId)&&(document.styleSheets[3].insertRule(`#${byId} {}`,o),s.push(byId)),o=styleNew.length,"default"===e&&-1!=s.indexOf(`#${byId} .by`)){let e=styleNew[5].style.color;for(l of styleNew)l.selectorText===`#${byId} .by`&&(e=l.style.color,l.style.color="");for(m of styleNew)m.selectorText===`#${byId}`&&(m.style.color=e)}}if("indi-name"===e){-1==s.indexOf(`#${byId} .by`)&&(document.styleSheets[4].insertRule(`#${byId} .by {}`,o),s.push(`#${byId} .by`));let e=styleNew[5].style.color;for(l of styleNew)l.selectorText==="#"+byId&&(e=l.style.color,l.style.color="");for(m of styleNew)m.selectorText===`#${byId} .by`&&""!=e&&(m.style.color=e)}t(byId)})),selectorText=[]})),document.querySelector(".example").addEventListener("click",hideMessageCP),tableColor("rgba(112, 32, 130, 1)"),$(".modal-content .reset, #modal-submit, .modal-close, #download-modal .reset, .modal-layer").on("click",(()=>{modaltog()})),document.getElementById("css-modal-openbtn").addEventListener("click",(()=>modaltog("#css-modal"))),document.getElementById("css-download").addEventListener("click",(()=>modaltog("#download-modal"))),new ClipboardJS("#copy"),$("[name='line']").change((()=>{var e=$("[name='line']:checked").val();$(".line-number").text(e)})),document.getElementById("log_submit").addEventListener("click",(function e(){$._data($("#log-input"),e),function(){null!=document.getElementById("profileImg")&&$("#profileImg").remove();$(".name-select>h2").nextAll().remove();const e='<select id="Name" style="visibility:hidden">\n    <option disabled selected>캐릭터를 선택하세요</option>\n  </select>';$(".name-select>h2")[0].insertAdjacentHTML("afterend",e),$(".example .general").not(".global").remove()}();var l=document.getElementById("log-input").value.replace(/(src="\/)/g,'src="https://app.roll20.net//');for(key of(l=(l=(l=(l=(l=(l=(l=l.replace(/\r|\n/gi,"")).replace(/(<span class="by">)\s+?/gi,'<span class="by">')).replace(/<span class=&quot;basicdiceroll&quot;>(.+?)<\/span>/gi,"$1")).replace(/(data-messageid=").+?"/gi,"")).replace(/(?<=\<a )href.+?"(?=>)/gi,"")).replace(/(<img class="sheet-brdright").+?\>/gi,"")).replace('roll20-colourised"','"'),Object.keys(diceinput)))l=l.replace(diceinput[key],"$1"+key);document.getElementById("log-content").innerHTML=l,addID(),$("#Name").change((function(){var e=$(this).find(":selected").text();let l=/\S+?(?=\s)/.exec(e);/PC\d+?\s/gi.test(e)?byId=e.replace(/PC\d+?\s+?/gi,"").match(/\S+?(?=\s|$)/gi,"")[0]:byId=null==l?e:l.shift();let n=[];$(".example .content>div").each((function(){n.push($(this).attr("id"))})),$("#Name").next().find(`[data-value='${$(this).val()}']`).addClass("disabled");let o=$(`.content span.by:contains('${e}:')`).siblings(".avatar:not('.noImage')").children("img").attr("src"),s=`<div class="message general" id=${byId}><div class="detail-button"><i class="material-icons-round">arrow_forward_ios</i></div><div class="cp-area"><i class="material-icons-round cp-close sp-replacer">close</i><input type='text' class='color-text' /><input type='text' class='color-bg' /></div><div class="spacer"></div><div class="avatar ${null==o?"noImage":""}" aria-hidden="true"><img src="${o}"></div><span class="tstamp" aria-hidden="true">January 15, 1234 5:66AM</span><span class="by">${e}:</span>안녕하세요? test 가나다</div>`;$(".example .content").append(s),t(byId)})),$(".example").on("click",".cp-close",(function(){const e=this.parentElement.parentElement.id;for(var t in styleNew)styleNew[t].selectorText==`#${e}`&&document.styleSheets[4].deleteRule(t);this.parentElement.parentElement.remove(),$("#Name").next().find(`[data-value^='${e}']`).removeClass("disabled")})),$("#Name>option").not("[disabled]").remove(),dropdownApp("#log-content .by","#Name"),$("#Name").niceSelect(),function(){const e=$(".item:last")[0],t='<div class="item" id="profileImg"><h2>프로필 이미지 수정</h2><p>음영 표시된 캐릭터는 깨진 아바타 이미지가 1개 이상 있는 캐릭터입니다. 캐릭터를 선택하고 <b>외부 이미지 주소</b>를 입력하면 일괄 변경됩니다.</p><p>변경하지 않고 그대로 두면 <b>백업시 깨진 이미지는 모두 삭제</b>됩니다.</p><div id="imgList" class="inner-box"></div>\n    <div class="btn-box">\n    <button class="btn reset"><i class="material-icons-round">replay</i></button>\n    <button class="btn apply">적용</button>\n    </div>\n    </div>';e.insertAdjacentHTML("afterend",t);const l=$("#profileImg>p")[1],n=$(".name-select>h2").nextAll();var o=n[0].cloneNode(!0),s=n[1].cloneNode(!0);o.id="changeImg",l.insertAdjacentElement("afterend",s),l.insertAdjacentElement("afterend",o),document.querySelector("#profileImg .apply").addEventListener("click",imgChange),$("#log-content .avatar>img").on("error",(function(){this.parentElement.classList.add("noImage");let e=this.parentElement.parentElement.id;document.querySelectorAll(".nice-select .option").forEach((function(t){t.textContent.split(" ")[0]===e&&t.classList.add("noImgChar")}))}))}(),$("#changeImg").change((function(){let e=this.value.split(" ")[0],t=document.querySelector(`#${e} .avatar img`).src;var l=`<div class="changeImg-box"><div><span>${$(this).val()}의 프로필 이미지</span><i class="material-icons-round close">close</i></div><input class="input-area" type="url" placeholder="외부 이미지 링크를 입력해주세요." onfocus="this.placeholder=''" onblur="this.placeholder='외부 이미지 링크를 입력해주세요.'"><img class="beforeimg" src="${t}"/><div class="preview-icon"><label class="material-icons-round">photo_size_select_actual<input type="checkbox"></label><img src=""></div></div>`;document.getElementById("imgList").insertAdjacentHTML("beforeend",l),$("#changeImg").next().find(`[data-value='${$(this).val()}']`).addClass("disabled")})),$("#imgList").on("mouseleave blur",".input-area",(function(){$(this).next().next().children("img").attr("src",$(this).val())})),$("#imgList").on("change",".preview-icon input",(function(){this.parentElement.nextElementSibling.classList.toggle("visible")})),$("#profileImg").on("click",".close",(function(){const e=$(this).prev("span").text(),t=/^.+(?=(의 프로필))/.exec(e);$(this).closest(".changeImg-box").remove(),$("#noImg").next().find(`[data-value='${t[0]}']`).removeClass("disabled")})),$("#profileImg .reset").on("click",(function(){document.querySelectorAll("#imgList .changeImg-box span").forEach((function(e){const t=/^.+(?=(의 프로필))/.exec(e.innerText);document.querySelectorAll(`#log-content #${t[0]} .avatar img`).forEach((function(e){e.src="noimg"}))}))}))})),document.querySelector(".custom .reset").addEventListener("click",(function(){pond.removeFiles(),document.getElementById("editing").value="",document.querySelector("#highlighting code").textContent=""})),document.querySelector("#html-reset").addEventListener("click",(()=>{document.querySelector("#log-input").innerText="",$("#log-content").empty()}));let e=["color","bg","spacer"];function t(e){document.styleSheets[4].insertRule(`#${e} {}`,styleNew.length);let t=document.querySelector("input[name='glo-name']:checked").value,l=$(`.example #${e} .by`).css("color"),n=$(`.example #${e}`).css("background-color"),o="indi-name"===t?" .by":"";$(`#${e} .color-text`).spectrum({color:l,preferredFormat:"hex3",move:function(t){cssChange(`#${e+o}`,"color",t)}}),$(`#${e} .color-bg`).spectrum({color:n,showAlpha:!0,preferredFormat:"hex3",move:function(t){cssChange("#"+e,"background-color",t)}})}["desc","emote","general","you","whisper"].forEach((t=>{e.forEach((e=>{makeGlobalCP(t,e)}))})),$(".cp-area>#dice-color").spectrum({color:$(".formula").css("color"),preferredFormat:"hex3",move:function(e){cssChange(".dicon","color",e)}})})),$((function(){hljs.highlightAll();let e=document.querySelector("#editing");e.oninput=function(){update(this.value),sync_scroll(this)},e.onscroll=function(){sync_scroll(this)},e.onkeydown=function(){check_tab(this,event)},document.getElementById("modal-reset").addEventListener("click",(function(){document.getElementById("editing").value="",document.getElementById("highlighting-content").innerText=""}))}));